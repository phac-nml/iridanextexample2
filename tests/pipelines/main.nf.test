nextflow_pipeline {

    name "Test pipeline"
    script "../../main.nf"
    tag "pipeline"

    test("Check iridanext output") {
        tag "iridanext_output"
        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {
            // Check that the iridanext output file exists and is gzipped
            def iridanextOutput = path("$outputDir/iridanext.output.json").json

            // Check contents of the iridanext output file
            def iridanext_samples = iridanextOutput.files.samples
            def iridanext_metadata = iridanextOutput.metadata.samples
            assert iridanext_samples.size() == 4
            assertContainsInAnyOrder(iridanext_samples.SAMPLE1_PE, [['path':'fastqc/SAMPLE1_PE_1_fastqc.html'], ['path':'fastqc/SAMPLE1_PE_2_fastqc.html']])
            assertContainsInAnyOrder(iridanext_samples.SAMPLE2_PE, [['path':'fastqc/SAMPLE2_PE_1_fastqc.html'], ['path':'fastqc/SAMPLE2_PE_2_fastqc.html']])
            assertContainsInAnyOrder(iridanext_samples.SAMPLE3_SE, [['path':'fastqc/SAMPLE3_SE_fastqc.html']])
            assertContainsInAnyOrder(iridanext_samples.SAMPLE4_SE, [['path':'fastqc/SAMPLE4_SE_fastqc.html']])

            assert iridanext_metadata.size() == 4
            assert iridanext_metadata.SAMPLE1_PE == ['id':'SAMPLE1_PE', 'single_end':'false']
            assert iridanext_metadata.SAMPLE2_PE == ['id':'SAMPLE2_PE', 'single_end':'false']
            assert iridanext_metadata.SAMPLE3_SE == ['id':'SAMPLE3_SE', 'single_end':'true']
            assert iridanext_metadata.SAMPLE4_SE == ['id':'SAMPLE4_SE', 'single_end':'true']
        }
    }
}